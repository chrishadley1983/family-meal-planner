generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model UnitOfMeasure {
  id                        String                     @id @default(uuid())
  code                      String                     @unique
  name                      String
  pluralName                String?
  abbreviation              String
  category                  String
  displayOrder              Int                        @default(0)
  isMetric                  Boolean                    @default(true)
  conversionFactor          Float?
  baseUnitCode              String?
  aliases                   String[]                   @default([])
  isActive                  Boolean                    @default(true)
  createdAt                 DateTime                   @default(now())
  inventoryItems            InventoryItem[]
  recipeIngredients         RecipeIngredient[]
  shoppingListExcludedItems ShoppingListExcludedItem[]
  shoppingListItems         ShoppingListItem[]
  staples                   Staple[]

  @@index([category])
  @@index([isActive])
  @@map("units_of_measure")
}

model User {
  id                        String                     @id @default(uuid())
  email                     String                     @unique
  passwordHash              String
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  lastLogin                 DateTime?
  preferences               Json                       @default("{}")
  settings                  AppSettings?
  profiles                  FamilyProfile[]
  inventory                 InventoryItem[]
  inventorySettings         InventorySettings?
  mealPlanSettings          MealPlanSettings?
  mealPlans                 MealPlan[]
  nutritionistConversations NutritionistConversation[]
  recipeHistory             RecipeUsageHistory[]
  recipes                   Recipe[]
  shoppingListCategories    ShoppingListCategory[]
  shoppingLists             ShoppingList[]
  staples                   Staple[]

  @@map("users")
}

model FamilyProfile {
  id                        String                       @id @default(uuid())
  userId                    String
  profileName               String
  age                       Int?
  avatarUrl                 String?
  foodLikes                 String[]
  foodDislikes              String[]
  allergies                 Json                         @default("[]")
  mealAvailability          Json                         @default("{}")
  activityLevel             String?
  dailyCalorieTarget        Int?
  dailyProteinTarget        Float?
  dailyCarbsTarget          Float?
  dailyFatTarget            Float?
  dailyFiberTarget          Float?
  macroTrackingEnabled      Boolean                      @default(false)
  createdAt                 DateTime                     @default(now())
  updatedAt                 DateTime                     @updatedAt
  isMainUser                Boolean                      @default(false)
  currentWeightKg           Decimal?                     @db.Decimal(5, 2)
  gender                    String?
  goalTimeframeWeeks        Int?
  goalType                  String?
  heightCm                  Int?
  targetWeightKg            Decimal?                     @db.Decimal(5, 2)
  user                      User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealParticipations        MealParticipant[]
  nutritionistConversations NutritionistConversation[]
  recipeCompatibility       RecipeProfileCompatibility[]

  @@unique([userId, profileName])
  @@index([userId])
  @@map("family_profiles")
}

model Recipe {
  id                      String                       @id @default(uuid())
  userId                  String
  recipeName              String
  description             String?
  imageUrl                String?
  servings                Int                          @default(4)
  prepTimeMinutes         Int?
  cookTimeMinutes         Int?
  totalTimeMinutes        Int?
  cuisineType             String?
  difficultyLevel         String?
  recipeSource            String?
  sourceUrl               String?
  timesUsed               Int                          @default(0)
  timesManuallySelected   Int                          @default(0)
  lastUsedDate            DateTime?
  familyRating            Float?
  ratingDate              DateTime?
  notes                   String?
  tags                    String[]
  yieldsMultipleMeals     Boolean                      @default(false)
  mealsYielded            Int?
  leftoverInstructions    String?
  freezable               Boolean                      @default(false)
  reheatingInstructions   String?
  caloriesPerServing      Int?
  proteinPerServing       Float?
  carbsPerServing         Float?
  fatPerServing           Float?
  fiberPerServing         Float?
  sugarPerServing         Float?
  sodiumPerServing        Int?
  nutritionAutoCalculated Boolean                      @default(false)
  createdAt               DateTime                     @default(now())
  updatedAt               DateTime                     @updatedAt
  isArchived              Boolean                      @default(false)
  isFavorite              Boolean                      @default(false)
  containsMeat            Boolean                      @default(false)
  containsNuts            Boolean                      @default(false)
  containsSeafood         Boolean                      @default(false)
  isDairyFree             Boolean                      @default(false)
  isGlutenFree            Boolean                      @default(false)
  isQuickMeal             Boolean                      @default(false)
  isVegan                 Boolean                      @default(false)
  isVegetarian            Boolean                      @default(false)
  mealType                String[]
  ingredientsHash         String?
  nutritionCalculatedAt   DateTime?
  nutritionConfidence     String?
  nutritionSource         String?
  aiOverallRating         String?
  aiOverallExplanation    String?
  aiIngredientRatings     Json?
  aiNutritionistFeedback  String?
  aiAnalysisCalculatedAt  DateTime?
  meals                   Meal[]
  ingredients             RecipeIngredient[]
  instructions            RecipeInstruction[]
  profileCompatibility    RecipeProfileCompatibility[]
  usageHistory            RecipeUsageHistory[]
  user                    User                         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyRating])
  @@index([timesUsed])
  @@map("recipes")
}

model RecipeIngredient {
  id             String         @id @default(uuid())
  recipeId       String
  ingredientName String
  quantity       Float
  unit           String
  category       String?
  notes          String?
  sortOrder      Int            @default(0)
  unitCode       String?
  recipe         Recipe         @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  unitOfMeasure  UnitOfMeasure? @relation(fields: [unitCode], references: [code])

  @@index([recipeId])
  @@index([unitCode])
  @@map("recipe_ingredients")
}

model RecipeInstruction {
  id           String @id @default(uuid())
  recipeId     String
  stepNumber   Int
  instruction  String
  timerMinutes Int?
  sortOrder    Int    @default(0)
  recipe       Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_instructions")
}

model RecipeProfileCompatibility {
  recipeId                String
  profileId               String
  isCompatible            Boolean       @default(true)
  incompatibleIngredients String[]
  profile                 FamilyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  recipe                  Recipe        @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@id([recipeId, profileId])
  @@map("recipe_profile_compatibility")
}

model MealPlan {
  id                       String                 @id @default(uuid())
  userId                   String
  weekStartDate            DateTime
  weekEndDate              DateTime
  status                   String                 @default("Draft")
  createdAt                DateTime               @default(now())
  finalizedAt              DateTime?
  weeklyNutritionalSummary Json                   @default("{}")
  customSchedule           Json?
  user                     User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  meals                    Meal[]
  recipeHistory            RecipeUsageHistory[]
  shoppingLists            ShoppingListMealPlan[]

  @@index([userId])
  @@index([weekStartDate, weekEndDate])
  @@map("meal_plans")
}

model Meal {
  id                  String            @id @default(uuid())
  mealPlanId          String
  dayOfWeek           String
  mealType            String
  recipeId            String?
  recipeName          String?
  servings            Int?
  scalingFactor       Float?
  isLeftover          Boolean           @default(false)
  leftoverFromMealId  String?
  notes               String?
  isLocked            Boolean           @default(false)
  nutritionalSummary  Json              @default("{}")
  createdAt           DateTime          @default(now())
  servingsManuallySet Boolean           @default(false)
  cookedAt            DateTime?
  inventoryDeducted   Boolean           @default(false)
  isCooked            Boolean           @default(false)
  participants        MealParticipant[]
  leftoverFromMeal    Meal?             @relation("LeftoverMeals", fields: [leftoverFromMealId], references: [id])
  leftoverMeals       Meal[]            @relation("LeftoverMeals")
  mealPlan            MealPlan          @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe              Recipe?           @relation(fields: [recipeId], references: [id])

  @@index([mealPlanId])
  @@index([recipeId])
  @@map("meals")
}

model MealParticipant {
  mealId      String
  profileId   String
  portionSize Float         @default(1.0)
  meal        Meal          @relation(fields: [mealId], references: [id], onDelete: Cascade)
  profile     FamilyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@id([mealId, profileId])
  @@map("meal_participants")
}

model Staple {
  id            String          @id @default(uuid())
  userId        String
  itemName      String
  quantity      Float
  unit          String
  category      String?
  frequency     StapleFrequency @default(weekly)
  isActive      Boolean         @default(true)
  lastAddedDate DateTime?
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  unitCode      String?
  stapleImports StapleImport[]
  unitOfMeasure UnitOfMeasure?  @relation(fields: [unitCode], references: [code])
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isActive])
  @@index([unitCode])
  @@map("staples")
}

model StapleImport {
  id             String       @id @default(uuid())
  stapleId       String
  shoppingListId String
  importedAt     DateTime     @default(now())
  wasForceAdd    Boolean      @default(false)
  finalizedAt    DateTime?
  shoppingList   ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  staple         Staple       @relation(fields: [stapleId], references: [id], onDelete: Cascade)

  @@index([stapleId])
  @@index([shoppingListId])
  @@index([shoppingListId, finalizedAt])
  @@map("staple_imports")
}

model InventoryItem {
  id                  String                     @id @default(uuid())
  userId              String
  itemName            String
  quantity            Float
  unit                String
  category            String
  expiryDate          DateTime?
  addedBy             String                     @default("manual")
  notes               String?
  updatedAt           DateTime                   @updatedAt
  createdAt           DateTime                   @default(now())
  expiryIsEstimated   Boolean                    @default(false)
  isActive            Boolean                    @default(true)
  purchaseDate        DateTime                   @default(now())
  location            StorageLocation?
  unitCode            String?
  isUsedInPlannedMeal Boolean                    @default(false)
  unitOfMeasure       UnitOfMeasure?             @relation(fields: [unitCode], references: [code])
  user                User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  exclusions          ShoppingListExcludedItem[]

  @@index([userId])
  @@index([userId, isActive])
  @@index([expiryDate])
  @@index([unitCode])
  @@map("inventory_items")
}

model IngredientShelfLife {
  id              String           @id @default(uuid())
  ingredientName  String           @unique
  shelfLifeDays   Int
  defaultLocation StorageLocation?
  category        String?
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([ingredientName])
  @@map("ingredient_shelf_life")
}

model InventorySettings {
  id                          String   @id @default(uuid())
  userId                      String   @unique
  skipInventoryCheck          Boolean  @default(false)
  smallQuantityThresholdGrams Float    @default(5)
  smallQuantityThresholdMl    Float    @default(5)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
  user                        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("inventory_settings")
}

model ShoppingListExcludedItem {
  id                String         @id @default(uuid())
  shoppingListId    String
  itemName          String
  recipeQuantity    Float
  recipeUnit        String
  inventoryQuantity Float
  inventoryItemId   String?
  excludedAt        DateTime       @default(now())
  addedBackAt       DateTime?
  addedBackQuantity Float?
  recipeUnitCode    String?
  inventoryItem     InventoryItem? @relation(fields: [inventoryItemId], references: [id])
  unitOfMeasure     UnitOfMeasure? @relation(fields: [recipeUnitCode], references: [code])
  shoppingList      ShoppingList   @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)

  @@index([shoppingListId])
  @@index([inventoryItemId])
  @@index([recipeUnitCode])
  @@map("shopping_list_excluded_items")
}

model ShoppingList {
  id            String                     @id @default(uuid())
  userId        String
  weekStartDate DateTime?
  status        String                     @default("Draft")
  categoryOrder String[]
  createdAt     DateTime                   @default(now())
  name          String                     @default("Shopping List")
  notes         String?
  updatedAt     DateTime                   @updatedAt
  finalizedAt   DateTime?
  archivedAt    DateTime?
  excludedItems ShoppingListExcludedItem[]
  items         ShoppingListItem[]
  mealPlans     ShoppingListMealPlan[]
  shareLinks    ShoppingListShareLink[]
  user          User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  stapleImports StapleImport[]

  @@index([userId])
  @@index([status])
  @@map("shopping_lists")
}

model ShoppingListMealPlan {
  id             String       @id @default(uuid())
  shoppingListId String
  mealPlanId     String
  importedAt     DateTime     @default(now())
  mealPlan       MealPlan     @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  shoppingList   ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)

  @@unique([shoppingListId, mealPlanId])
  @@index([shoppingListId])
  @@index([mealPlanId])
  @@map("shopping_list_meal_plans")
}

model ShoppingListCategory {
  id           String   @id @default(uuid())
  userId       String
  name         String
  displayOrder Int      @default(0)
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("shopping_list_categories")
}

model ShoppingListItem {
  id                String         @id @default(uuid())
  shoppingListId    String
  itemName          String
  quantity          Float
  unit              String
  category          String?
  source            String?
  sourceDetails     Json           @default("[]")
  isConsolidated    Boolean        @default(false)
  inInventory       Boolean        @default(false)
  inventoryQuantity Float?
  netQuantityNeeded Float?
  isPurchased       Boolean        @default(false)
  customNote        String?
  priority          String         @default("Medium")
  createdAt         DateTime       @default(now())
  displayOrder      Int            @default(0)
  updatedAt         DateTime       @updatedAt
  originalItemName  String?
  unitCode          String?
  shoppingList      ShoppingList   @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  unitOfMeasure     UnitOfMeasure? @relation(fields: [unitCode], references: [code])

  @@index([shoppingListId])
  @@index([category])
  @@index([unitCode])
  @@map("shopping_list_items")
}

model ShoppingListShareLink {
  id             String       @id @default(uuid())
  shoppingListId String
  shareToken     String       @unique
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  shoppingList   ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)

  @@index([shareToken])
  @@index([shoppingListId])
  @@index([expiresAt])
  @@map("shopping_list_share_links")
}

model AppSettings {
  userId                  String   @id
  theme                   String   @default("Auto")
  notificationsEnabled    Boolean  @default(true)
  notificationPreferences Json     @default("{}")
  mealPlanningPreferences Json     @default("{}")
  shoppingListPreferences Json     @default("{}")
  aiPreferences           Json     @default("{}")
  updatedAt               DateTime @updatedAt
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("app_settings")
}

model MealPlanSettings {
  id                  String   @id @default(uuid())
  userId              String   @unique
  macroMode           String   @default("balanced")
  varietyEnabled      Boolean  @default(true)
  dinnerCooldown      Int      @default(14)
  lunchCooldown       Int      @default(7)
  breakfastCooldown   Int      @default(3)
  snackCooldown       Int      @default(2)
  minCuisines         Int      @default(3)
  maxSameCuisine      Int      @default(2)
  shoppingMode        String   @default("moderate")
  expiryPriority      String   @default("moderate")
  expiryWindow        Int      @default(5)
  useItUpItems        String[] @default([])
  batchCookingEnabled Boolean  @default(true)
  maxLeftoverDays     Int      @default(4)
  priorityOrder       String[] @default(["macros", "ratings", "variety", "shopping", "prep", "time"])
  feedbackDetail      String   @default("medium")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("meal_plan_settings")
}

model RecipeUsageHistory {
  id         String   @id @default(uuid())
  userId     String
  recipeId   String
  mealPlanId String
  usedDate   DateTime
  mealType   String
  wasManual  Boolean  @default(false)
  createdAt  DateTime @default(now())
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe     Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId, mealPlanId, usedDate])
  @@index([userId, recipeId, usedDate])
  @@index([userId, usedDate])
  @@map("recipe_usage_history")
}

model NutritionistConversation {
  id        String                @id @default(uuid())
  userId    String
  profileId String
  title     String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  profile   FamilyProfile         @relation(fields: [profileId], references: [id], onDelete: Cascade)
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  NutritionistMessage[]

  @@index([userId])
  @@index([profileId])
  @@map("nutritionist_conversations")
}

model NutritionistMessage {
  id             String                   @id @default(uuid())
  conversationId String
  role           String
  content        String
  metadata       Json?
  createdAt      DateTime                 @default(now())
  conversation   NutritionistConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("nutritionist_messages")
}

model IngredientNutritionCache {
  id              String   @id @default(uuid())
  ingredientName  String   @unique
  normalizedName  String
  fdcId           Int?
  caloriesPer100g Int
  proteinPer100g  Float
  carbsPer100g    Float
  fatPer100g      Float
  fiberPer100g    Float    @default(0)
  sugarPer100g    Float    @default(0)
  sodiumPer100g   Int      @default(0)
  source          String   @default("usda")
  confidence      String   @default("high")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([normalizedName])
  @@index([source])
  @@map("ingredient_nutrition_cache")
}

model RecipeSourceSite {
  id                    String         @id @default(uuid())
  name                  String         @unique
  displayName           String
  baseUrl               String
  searchUrlPattern      String
  searchResultsSelector String?
  categories            String[]
  isActive              Boolean        @default(true)
  lastScrapedAt         DateTime?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  masterRecipes         MasterRecipe[]

  @@index([isActive])
  @@map("recipe_source_sites")
}

model MasterRecipe {
  id                 String           @id @default(uuid())
  sourceUrl          String           @unique
  sourceSiteId       String
  sourceScrapedAt    DateTime
  name               String
  description        String?
  imageUrl           String?
  servings           Int?
  prepTimeMinutes    Int?
  cookTimeMinutes    Int?
  totalTimeMinutes   Int?
  cuisineType        String?
  mealCategory       String[]
  dietaryTags        String[]
  ingredients        Json
  ingredientNames    String[]
  instructions       Json
  caloriesPerServing Int?
  proteinPerServing  Decimal?         @db.Decimal(6, 2)
  carbsPerServing    Decimal?         @db.Decimal(6, 2)
  fatPerServing      Decimal?         @db.Decimal(6, 2)
  fiberPerServing    Decimal?         @db.Decimal(6, 2)
  sugarPerServing    Decimal?         @db.Decimal(6, 2)
  sodiumPerServing   Int?
  nutritionSource    String?
  allergens          String[]
  dataQualityScore   Int              @default(0)
  isActive           Boolean          @default(true)
  importErrors       String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  sourceSite         RecipeSourceSite @relation(fields: [sourceSiteId], references: [id])

  @@index([sourceSiteId])
  @@index([cuisineType])
  @@index([mealCategory])
  @@index([ingredientNames])
  @@index([allergens])
  @@index([caloriesPerServing])
  @@index([proteinPerServing])
  @@index([totalTimeMinutes])
  @@index([isActive])
  @@index([dataQualityScore])
  @@index([name])
  @@map("master_recipes")
}

model RecipeScrapingJob {
  id             String            @id @default(uuid())
  sourceSiteId   String?
  category       String?
  status         ScrapingJobStatus @default(pending)
  urlsDiscovered Int               @default(0)
  urlsProcessed  Int               @default(0)
  urlsSucceeded  Int               @default(0)
  urlsFailed     Int               @default(0)
  urlsSkipped    Int               @default(0)
  startedAt      DateTime?
  completedAt    DateTime?
  errorLog       String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([status])
  @@index([sourceSiteId])
  @@map("recipe_scraping_jobs")
}

enum StapleFrequency {
  weekly
  every_2_weeks
  every_4_weeks
  every_3_months
}

enum StorageLocation {
  fridge
  freezer
  cupboard
  pantry
}

enum ScrapingJobStatus {
  pending
  running
  completed
  failed
}
