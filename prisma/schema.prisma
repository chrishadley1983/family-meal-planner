// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Units of Measure - reference table for consistent unit handling
model UnitOfMeasure {
  id               String   @id @default(uuid())
  code             String   @unique  // 'g', 'ml', 'pack', etc. - used as FK reference
  name             String             // 'grams', 'millilitres', 'pack'
  pluralName       String?            // 'grams', 'packs'
  abbreviation     String             // 'g', 'ml', 'pk'
  category         String             // 'weight', 'volume', 'count', 'spoon'
  displayOrder     Int      @default(0)
  isMetric         Boolean  @default(true)
  conversionFactor Float?             // Factor to convert to base unit (e.g., 1000 for kg->g)
  baseUnitCode     String?            // Reference to base unit code (e.g., 'g' for 'kg')
  aliases          String[] @default([])
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())

  // Relations - FK references from other tables
  recipeIngredients         RecipeIngredient[]
  staples                   Staple[]
  inventoryItems            InventoryItem[]
  shoppingListItems         ShoppingListItem[]
  shoppingListExcludedItems ShoppingListExcludedItem[]

  @@index([category])
  @@index([isActive])
  @@map("units_of_measure")
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLogin    DateTime?
  preferences  Json      @default("{}")

  profiles                  FamilyProfile[]
  recipes                   Recipe[]
  mealPlans                 MealPlan[]
  shoppingLists             ShoppingList[]
  shoppingListCategories    ShoppingListCategory[]
  inventory                 InventoryItem[]
  staples                   Staple[]
  settings                  AppSettings?
  mealPlanSettings          MealPlanSettings?
  inventorySettings         InventorySettings?
  recipeHistory             RecipeUsageHistory[]
  nutritionistConversations NutritionistConversation[]

  @@map("users")
}

model FamilyProfile {
  id                   String   @id @default(uuid())
  userId               String
  profileName          String
  age                  Int?
  avatarUrl            String?
  foodLikes            String[]
  foodDislikes         String[]
  allergies            Json     @default("[]")
  mealAvailability     Json     @default("{}")
  activityLevel        String?
  dailyCalorieTarget   Int?
  dailyProteinTarget   Float?
  dailyCarbsTarget     Float?
  dailyFatTarget       Float?
  dailyFiberTarget     Float?
  macroTrackingEnabled Boolean  @default(false)
  isMainUser           Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Body stats for TDEE/macro calculation
  currentWeightKg    Decimal? @db.Decimal(5, 2)
  targetWeightKg     Decimal? @db.Decimal(5, 2)
  heightCm           Int?
  gender             String?
  goalType           String?  // 'lose', 'maintain', 'gain'
  goalTimeframeWeeks Int?

  user                         User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealParticipations           MealParticipant[]
  recipeCompatibility          RecipeProfileCompatibility[]
  nutritionistConversations    NutritionistConversation[]

  @@unique([userId, profileName])
  @@index([userId])
  @@map("family_profiles")
}

model Recipe {
  id                      String    @id @default(uuid())
  userId                  String
  recipeName              String
  description             String?
  imageUrl                String?
  servings                Int       @default(4)
  prepTimeMinutes         Int?
  cookTimeMinutes         Int?
  totalTimeMinutes        Int?
  cuisineType             String?
  mealType                String[]
  difficultyLevel         String?
  recipeSource            String?
  sourceUrl               String?
  timesUsed               Int       @default(0)
  timesManuallySelected   Int       @default(0)
  lastUsedDate            DateTime?
  familyRating            Float?
  ratingDate              DateTime?
  notes                   String?
  tags                    String[]
  isVegetarian            Boolean   @default(false)
  isVegan                 Boolean   @default(false)
  containsMeat            Boolean   @default(false)
  containsSeafood         Boolean   @default(false)
  isDairyFree             Boolean   @default(false)
  isGlutenFree            Boolean   @default(false)
  containsNuts            Boolean   @default(false)
  isQuickMeal             Boolean   @default(false)
  yieldsMultipleMeals     Boolean   @default(false)
  mealsYielded            Int?
  leftoverInstructions    String?
  freezable               Boolean   @default(false)
  reheatingInstructions   String?
  caloriesPerServing      Int?
  proteinPerServing       Float?
  carbsPerServing         Float?
  fatPerServing           Float?
  fiberPerServing         Float?
  sugarPerServing         Float?
  sodiumPerServing        Int?
  nutritionAutoCalculated Boolean   @default(false)
  isFavorite              Boolean   @default(false)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  isArchived              Boolean   @default(false)

  // Nutrition tracking for smart recalculation
  ingredientsHash         String?            // SHA256 hash of sorted ingredients JSON
  nutritionCalculatedAt   DateTime?          // When macros were last calculated
  nutritionSource         String?            // 'calculated' | 'manual' | 'legacy' | 'ai_estimated'
  nutritionConfidence     String?            // 'high' | 'medium' | 'low'

  user                 User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredients          RecipeIngredient[]
  instructions         RecipeInstruction[]
  profileCompatibility RecipeProfileCompatibility[]
  meals                Meal[]
  usageHistory         RecipeUsageHistory[]

  @@index([userId])
  @@index([familyRating])
  @@index([timesUsed])
  @@map("recipes")
}

model RecipeIngredient {
  id             String  @id @default(uuid())
  recipeId       String
  ingredientName String
  quantity       Float
  unit           String           // Original string value (kept for migration)
  unitCode       String?          // FK to UnitOfMeasure.code
  category       String?
  notes          String?
  sortOrder      Int     @default(0)

  recipe        Recipe          @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  unitOfMeasure UnitOfMeasure?  @relation(fields: [unitCode], references: [code])

  @@index([recipeId])
  @@index([unitCode])
  @@map("recipe_ingredients")
}

model RecipeInstruction {
  id           String @id @default(uuid())
  recipeId     String
  stepNumber   Int
  instruction  String
  timerMinutes Int?
  sortOrder    Int    @default(0)

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_instructions")
}

model RecipeProfileCompatibility {
  recipeId                String
  profileId               String
  isCompatible            Boolean  @default(true)
  incompatibleIngredients String[]

  recipe  Recipe        @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  profile FamilyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@id([recipeId, profileId])
  @@map("recipe_profile_compatibility")
}

model MealPlan {
  id                       String    @id @default(uuid())
  userId                   String
  weekStartDate            DateTime
  weekEndDate              DateTime
  status                   String    @default("Draft")
  customSchedule           Json?
  createdAt                DateTime  @default(now())
  finalizedAt              DateTime?
  weeklyNutritionalSummary Json      @default("{}")

  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  meals         Meal[]
  shoppingLists ShoppingListMealPlan[]
  recipeHistory RecipeUsageHistory[]

  @@index([userId])
  @@index([weekStartDate, weekEndDate])
  @@map("meal_plans")
}

model Meal {
  id                  String    @id @default(uuid())
  mealPlanId          String
  dayOfWeek           String
  mealType            String
  recipeId            String?
  recipeName          String?
  servings            Int?
  servingsManuallySet Boolean   @default(false)
  scalingFactor       Float?
  isLeftover          Boolean   @default(false)
  leftoverFromMealId  String?
  notes               String?
  isLocked            Boolean   @default(false)
  nutritionalSummary  Json      @default("{}")
  isCooked            Boolean   @default(false)
  cookedAt            DateTime?
  inventoryDeducted   Boolean   @default(false)
  createdAt           DateTime  @default(now())

  mealPlan         MealPlan          @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe           Recipe?           @relation(fields: [recipeId], references: [id], onDelete: SetNull)
  leftoverFromMeal Meal?             @relation("LeftoverMeals", fields: [leftoverFromMealId], references: [id], onDelete: SetNull)
  leftoverMeals    Meal[]            @relation("LeftoverMeals")
  participants     MealParticipant[]

  @@index([mealPlanId])
  @@index([recipeId])
  @@map("meals")
}

model MealParticipant {
  mealId      String
  profileId   String
  portionSize Float  @default(1.0)

  meal    Meal          @relation(fields: [mealId], references: [id], onDelete: Cascade)
  profile FamilyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@id([mealId, profileId])
  @@map("meal_participants")
}

// Staple frequency enum
enum StapleFrequency {
  weekly
  every_2_weeks
  every_4_weeks
  every_3_months
}

model Staple {
  id            String          @id @default(uuid())
  userId        String
  itemName      String
  quantity      Float
  unit          String           // Original string value (kept for migration)
  unitCode      String?          // FK to UnitOfMeasure.code
  category      String?
  frequency     StapleFrequency @default(weekly)
  isActive      Boolean         @default(true)
  lastAddedDate DateTime?
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  unitOfMeasure UnitOfMeasure?  @relation(fields: [unitCode], references: [code])
  stapleImports StapleImport[]

  @@index([userId])
  @@index([userId, isActive])
  @@index([unitCode])
  @@map("staples")
}

model StapleImport {
  id             String    @id @default(uuid())
  stapleId       String
  shoppingListId String
  importedAt     DateTime  @default(now())
  wasForceAdd    Boolean   @default(false)
  finalizedAt    DateTime?

  staple       Staple       @relation(fields: [stapleId], references: [id], onDelete: Cascade)
  shoppingList ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)

  @@index([stapleId])
  @@index([shoppingListId])
  @@index([shoppingListId, finalizedAt])
  @@map("staple_imports")
}

// Storage location enum for inventory items
enum StorageLocation {
  fridge
  freezer
  cupboard
  pantry
}

model InventoryItem {
  id                  String           @id @default(uuid())
  userId              String
  itemName            String
  quantity            Float
  unit                String            // Original string value (kept for migration)
  unitCode            String?           // FK to UnitOfMeasure.code
  category            String
  location            StorageLocation?
  purchaseDate        DateTime         @default(now())
  expiryDate          DateTime?
  expiryIsEstimated   Boolean          @default(false)
  isActive            Boolean          @default(true)
  addedBy             String           @default("manual") // manual, csv, photo, shopping_list
  notes               String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  user          User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  unitOfMeasure UnitOfMeasure?              @relation(fields: [unitCode], references: [code])
  exclusions    ShoppingListExcludedItem[]

  @@index([userId])
  @@index([userId, isActive])
  @@index([expiryDate])
  @@index([unitCode])
  @@map("inventory_items")
}

// Reference table for ingredient shelf life data
model IngredientShelfLife {
  id                   String           @id @default(uuid())
  ingredientName       String           @unique
  shelfLifeDays        Int
  defaultLocation      StorageLocation?
  category             String?
  notes                String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt

  @@index([ingredientName])
  @@map("ingredient_shelf_life")
}

// User settings for inventory management
model InventorySettings {
  id                          String   @id @default(uuid())
  userId                      String   @unique
  skipInventoryCheck          Boolean  @default(false)
  smallQuantityThresholdGrams Float    @default(5)
  smallQuantityThresholdMl    Float    @default(5)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("inventory_settings")
}

// Tracks items excluded from shopping list due to inventory
model ShoppingListExcludedItem {
  id                String    @id @default(uuid())
  shoppingListId    String
  itemName          String
  recipeQuantity    Float
  recipeUnit        String           // Original string value (kept for migration)
  recipeUnitCode    String?          // FK to UnitOfMeasure.code
  inventoryQuantity Float
  inventoryItemId   String?
  excludedAt        DateTime  @default(now())
  addedBackAt       DateTime?
  addedBackQuantity Float?

  shoppingList  ShoppingList   @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  unitOfMeasure UnitOfMeasure? @relation(fields: [recipeUnitCode], references: [code])

  @@index([shoppingListId])
  @@index([inventoryItemId])
  @@index([recipeUnitCode])
  @@map("shopping_list_excluded_items")
}

model ShoppingList {
  id            String    @id @default(uuid())
  userId        String
  name          String    @default("Shopping List")
  notes         String?
  weekStartDate DateTime?
  status        String    @default("Draft") // Draft, Finalized, Archived
  categoryOrder String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  finalizedAt   DateTime?
  archivedAt    DateTime?

  user          User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items         ShoppingListItem[]
  mealPlans     ShoppingListMealPlan[]
  stapleImports StapleImport[]
  shareLinks    ShoppingListShareLink[]
  excludedItems ShoppingListExcludedItem[]

  @@index([userId])
  @@index([status])
  @@map("shopping_lists")
}

model ShoppingListMealPlan {
  id             String   @id @default(uuid())
  shoppingListId String
  mealPlanId     String
  importedAt     DateTime @default(now())

  shoppingList ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  mealPlan     MealPlan     @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)

  @@unique([shoppingListId, mealPlanId])
  @@index([shoppingListId])
  @@index([mealPlanId])
  @@map("shopping_list_meal_plans")
}

model ShoppingListCategory {
  id           String   @id @default(uuid())
  userId       String
  name         String
  displayOrder Int      @default(0)
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
  @@map("shopping_list_categories")
}

model ShoppingListItem {
  id                String   @id @default(uuid())
  shoppingListId    String
  itemName          String
  originalItemName  String?  // Original name before user edits, for inventory tracking
  quantity          Float
  unit              String           // Original string value (kept for migration)
  unitCode          String?          // FK to UnitOfMeasure.code
  category          String?
  source            String? // recipe, staple, manual
  sourceDetails     Json     @default("[]") // Array of {type, id, name, quantity}
  isConsolidated    Boolean  @default(false)
  inInventory       Boolean  @default(false)
  inventoryQuantity Float?
  netQuantityNeeded Float?
  isPurchased       Boolean  @default(false)
  customNote        String?
  priority          String   @default("Medium") // Low, Medium, High
  displayOrder      Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  shoppingList  ShoppingList   @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  unitOfMeasure UnitOfMeasure? @relation(fields: [unitCode], references: [code])

  @@index([shoppingListId])
  @@index([category])
  @@index([unitCode])
  @@map("shopping_list_items")
}

model ShoppingListShareLink {
  id             String   @id @default(uuid())
  shoppingListId String
  shareToken     String   @unique
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  shoppingList ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)

  @@index([shareToken])
  @@index([shoppingListId])
  @@index([expiresAt])
  @@map("shopping_list_share_links")
}

model AppSettings {
  userId                  String   @id
  theme                   String   @default("Auto")
  notificationsEnabled    Boolean  @default(true)
  notificationPreferences Json     @default("{}")
  mealPlanningPreferences Json     @default("{}")
  shoppingListPreferences Json     @default("{}")
  aiPreferences           Json     @default("{}")
  updatedAt               DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("app_settings")
}

model MealPlanSettings {
  id     String @id @default(uuid())
  userId String @unique

  // Macro Targeting
  macroMode String @default("balanced")

  // Recipe Variety
  varietyEnabled    Boolean @default(true)
  dinnerCooldown    Int     @default(14)
  lunchCooldown     Int     @default(7)
  breakfastCooldown Int     @default(3)
  snackCooldown     Int     @default(2)
  minCuisines       Int     @default(3)
  maxSameCuisine    Int     @default(2)

  // Shopping Efficiency
  shoppingMode String @default("moderate")

  // Inventory & Expiry
  expiryPriority String   @default("moderate")
  expiryWindow   Int      @default(5)
  useItUpItems   String[] @default([])

  // Batch Cooking
  batchCookingEnabled Boolean @default(true)
  maxLeftoverDays     Int     @default(4)

  // Priority Ordering
  priorityOrder String[] @default(["macros", "ratings", "variety", "shopping", "prep", "time"])

  // Sarah's Feedback
  feedbackDetail String @default("medium")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("meal_plan_settings")
}

model RecipeUsageHistory {
  id         String   @id @default(uuid())
  userId     String
  recipeId   String
  mealPlanId String
  usedDate   DateTime
  mealType   String
  wasManual  Boolean  @default(false)
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  mealPlan MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId, mealPlanId, usedDate])
  @@index([userId, recipeId, usedDate])
  @@index([userId, usedDate])
  @@map("recipe_usage_history")
}

// Nutritionist conversation tracking
model NutritionistConversation {
  id        String   @id @default(uuid())
  userId    String
  profileId String
  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  profile  FamilyProfile         @relation(fields: [profileId], references: [id], onDelete: Cascade)
  messages NutritionistMessage[]

  @@index([userId])
  @@index([profileId])
  @@map("nutritionist_conversations")
}

model NutritionistMessage {
  id             String   @id @default(uuid())
  conversationId String
  role           String   // 'user' | 'assistant'
  content        String
  metadata       Json?    // Store suggested actions, applied changes, etc.
  createdAt      DateTime @default(now())

  conversation NutritionistConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("nutritionist_messages")
}

// Persistent cache for ingredient nutrition data from USDA
model IngredientNutritionCache {
  id               String   @id @default(uuid())
  ingredientName   String   @unique  // Original ingredient name
  normalizedName   String             // Cleaned name for fuzzy matching
  fdcId            Int?               // USDA FoodData Central ID (null if AI-estimated)

  // Nutrition per 100g
  caloriesPer100g  Int
  proteinPer100g   Float
  carbsPer100g     Float
  fatPer100g       Float
  fiberPer100g     Float    @default(0)
  sugarPer100g     Float    @default(0)
  sodiumPer100g    Int      @default(0)

  // Metadata
  source           String   @default("usda")  // 'usda' | 'ai_estimate' | 'seed_data' | 'manual'
  confidence       String   @default("high")  // 'high' | 'medium' | 'low'

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([normalizedName])
  @@index([source])
  @@map("ingredient_nutrition_cache")
}
