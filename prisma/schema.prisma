// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?
  preferences   Json      @default("{}")

  profiles      FamilyProfile[]
  recipes       Recipe[]
  mealPlans     MealPlan[]
  shoppingLists ShoppingList[]
  inventory     InventoryItem[]
  staples       WeeklyStaple[]
  settings      AppSettings?

  @@map("users")
}

model FamilyProfile {
  id                    String   @id @default(uuid())
  userId                String
  profileName           String
  age                   Int?
  avatarUrl             String?
  foodLikes             String[]
  foodDislikes          String[]
  allergies             Json     @default("[]")
  mealAvailability      Json     @default("{}")
  activityLevel         String?
  dailyCalorieTarget    Int?
  dailyProteinTarget    Float?
  dailyCarbsTarget      Float?
  dailyFatTarget        Float?
  dailyFiberTarget      Float?
  macroTrackingEnabled  Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealParticipations    MealParticipant[]
  recipeCompatibility   RecipeProfileCompatibility[]

  @@unique([userId, profileName])
  @@index([userId])
  @@map("family_profiles")
}

model Recipe {
  id                      String   @id @default(uuid())
  userId                  String
  recipeName              String
  description             String?
  imageUrl                String?
  servings                Int      @default(4)
  prepTimeMinutes         Int?
  cookTimeMinutes         Int?
  totalTimeMinutes        Int?
  cuisineType             String?
  mealCategory            String[]
  difficultyLevel         String?
  recipeSource            String?
  sourceUrl               String?
  timesUsed               Int      @default(0)
  timesManuallySelected   Int      @default(0)
  lastUsedDate            DateTime?
  familyRating            Float?
  ratingDate              DateTime?
  notes                   String?
  tags                    String[]
  yieldsMultipleMeals     Boolean  @default(false)
  mealsYielded            Int?
  leftoverInstructions    String?
  freezable               Boolean  @default(false)
  reheatingInstructions   String?
  caloriesPerServing      Int?
  proteinPerServing       Float?
  carbsPerServing         Float?
  fatPerServing           Float?
  fiberPerServing         Float?
  sugarPerServing         Float?
  sodiumPerServing        Int?
  nutritionAutoCalculated Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  isArchived              Boolean  @default(false)

  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ingredients             RecipeIngredient[]
  instructions            RecipeInstruction[]
  profileCompatibility    RecipeProfileCompatibility[]
  meals                   Meal[]

  @@index([userId])
  @@index([familyRating])
  @@index([timesUsed])
  @@map("recipes")
}

model RecipeIngredient {
  id             String  @id @default(uuid())
  recipeId       String
  ingredientName String
  quantity       Float
  unit           String
  category       String?
  notes          String?
  sortOrder      Int     @default(0)

  recipe         Recipe  @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_ingredients")
}

model RecipeInstruction {
  id           String  @id @default(uuid())
  recipeId     String
  stepNumber   Int
  instruction  String
  timerMinutes Int?
  sortOrder    Int     @default(0)

  recipe       Recipe  @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@map("recipe_instructions")
}

model RecipeProfileCompatibility {
  recipeId               String
  profileId              String
  isCompatible           Boolean  @default(true)
  incompatibleIngredients String[]

  recipe                 Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  profile                FamilyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@id([recipeId, profileId])
  @@map("recipe_profile_compatibility")
}

model MealPlan {
  id                       String   @id @default(uuid())
  userId                   String
  weekStartDate            DateTime
  weekEndDate              DateTime
  status                   String   @default("Draft")
  createdAt                DateTime @default(now())
  finalizedAt              DateTime?
  weeklyNutritionalSummary Json     @default("{}")

  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  meals                    Meal[]
  shoppingLists            ShoppingList[]

  @@index([userId])
  @@index([weekStartDate, weekEndDate])
  @@map("meal_plans")
}

model Meal {
  id                  String   @id @default(uuid())
  mealPlanId          String
  dayOfWeek           String
  mealType            String
  recipeId            String?
  recipeName          String?
  servings            Int?
  scalingFactor       Float?
  isLeftover          Boolean  @default(false)
  leftoverFromMealId  String?
  notes               String?
  isLocked            Boolean  @default(false)
  nutritionalSummary  Json     @default("{}")
  createdAt           DateTime @default(now())

  mealPlan            MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe              Recipe?  @relation(fields: [recipeId], references: [id], onDelete: SetNull)
  leftoverFromMeal    Meal?    @relation("LeftoverMeals", fields: [leftoverFromMealId], references: [id], onDelete: SetNull)
  leftoverMeals       Meal[]   @relation("LeftoverMeals")
  participants        MealParticipant[]

  @@index([mealPlanId])
  @@index([recipeId])
  @@map("meals")
}

model MealParticipant {
  mealId      String
  profileId   String
  portionSize Float   @default(1.0)

  meal        Meal    @relation(fields: [mealId], references: [id], onDelete: Cascade)
  profile     FamilyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@id([mealId, profileId])
  @@map("meal_participants")
}

model WeeklyStaple {
  id            String  @id @default(uuid())
  userId        String
  itemName      String
  quantity      Float
  unit          String
  category      String?
  autoAddToList Boolean @default(true)
  notes         String?
  createdAt     DateTime @default(now())

  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("weekly_staples")
}

model InventoryItem {
  id                   String   @id @default(uuid())
  userId               String
  itemName             String
  quantity             Float
  unit                 String
  category             String
  location             String
  expiryDate           DateTime?
  autoPopulatedExpiry  Boolean  @default(false)
  dateAdded            DateTime @default(now())
  addedBy              String   @default("Manual")
  notes                String?
  isUsedInPlannedMeal  Boolean  @default(false)
  updatedAt            DateTime @updatedAt

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiryDate])
  @@map("inventory_items")
}

model ShoppingList {
  id            String   @id @default(uuid())
  userId        String
  mealPlanId    String?
  weekStartDate DateTime
  status        String   @default("Generated")
  categoryOrder String[]
  generatedAt   DateTime @default(now())
  completedAt   DateTime?

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealPlan      MealPlan? @relation(fields: [mealPlanId], references: [id], onDelete: SetNull)
  items         ShoppingListItem[]

  @@index([userId])
  @@index([mealPlanId])
  @@map("shopping_lists")
}

model ShoppingListItem {
  id                 String   @id @default(uuid())
  shoppingListId     String
  itemName           String
  quantity           Float
  unit               String
  category           String?
  source             String?
  sourceDetails      Json     @default("[]")
  isConsolidated     Boolean  @default(false)
  inInventory        Boolean  @default(false)
  inventoryQuantity  Float?
  netQuantityNeeded  Float?
  isPurchased        Boolean  @default(false)
  customNote         String?
  priority           String   @default("Medium")
  createdAt          DateTime @default(now())

  shoppingList       ShoppingList @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)

  @@index([shoppingListId])
  @@map("shopping_list_items")
}

model AppSettings {
  userId                    String   @id
  theme                     String   @default("Auto")
  notificationsEnabled      Boolean  @default(true)
  notificationPreferences   Json     @default("{}")
  mealPlanningPreferences   Json     @default("{}")
  shoppingListPreferences   Json     @default("{}")
  aiPreferences             Json     @default("{}")
  updatedAt                 DateTime @updatedAt

  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("app_settings")
}
