# Test Approach Document

**Project:** Family Meal Planner
**Last Updated:** {{DATE}}
**Generated By:** Test Plan Agent

---

## 1. Test Strategy Overview

### 1.1 Testing Pyramid

```
                    /\
                   /  \
                  / E2E \           <- Few, slow, high-value
                 /______\              (Critical user journeys)
                /        \
               /Integration\        <- Some, medium speed
              /____________\           (API contracts, data flow)
             /              \
            /   Unit Tests   \      <- Many, fast, isolated
           /__________________\        (Business logic, calculations)
```

### 1.2 Test Types

| Type | Purpose | Framework | Location | Execution Time |
|------|---------|-----------|----------|----------------|
| **Unit** | Verify isolated business logic | Jest | `tests/unit/` | Fast (<5s each) |
| **API** | Verify endpoint behavior with mocked DB | Jest | `tests/api/` | Medium (~10s each) |
| **Integration** | Verify component interactions | Jest | `tests/integration/` | Medium (~15s each) |
| **E2E** | Verify complete user journeys | Playwright MCP | `tests/e2e/` | Slow (~30-60s each) |

### 1.3 Coverage Targets

| Test Type | Branches | Functions | Lines | Statements |
|-----------|----------|-----------|-------|------------|
| Unit | 80% | 85% | 85% | 85% |
| Integration | 60% | 70% | 70% | 70% |
| Overall | 70% | 80% | 80% | 80% |

---

## 2. Test Execution Modes

### 2.1 Quick Check (`quick`)
- **When:** During active development, before commits
- **Duration:** ~60 seconds
- **Scope:** Unit tests for critical features only
- **Coverage:** Not required

### 2.2 Unit Tests (`unit`)
- **When:** After completing a unit of work
- **Duration:** ~2 minutes
- **Scope:** All unit tests
- **Coverage:** 60% branches, 70% functions/lines

### 2.3 API Tests (`api`)
- **When:** After API changes
- **Duration:** ~3 minutes
- **Scope:** All API endpoint tests
- **Coverage:** 50% branches, 60% functions/lines

### 2.4 Integration (`integration`)
- **When:** After significant changes affecting multiple components
- **Duration:** ~5 minutes
- **Scope:** API + Integration tests
- **Coverage:** 50% branches, 60% functions/lines

### 2.5 E2E Tests (`e2e`)
- **When:** Before releases, after UI changes
- **Duration:** ~10 minutes
- **Scope:** All E2E browser tests
- **Coverage:** Not measured (browser-based)

### 2.6 E2E Critical (`e2e-critical`)
- **When:** Quick validation of critical paths
- **Duration:** ~5 minutes
- **Scope:** Critical user journey E2E only
- **Coverage:** Not measured

### 2.7 Regression (`regression`)
- **When:** Before merging to main
- **Duration:** ~10 minutes
- **Scope:** Unit + API + Integration
- **Coverage:** 60% branches, 70% functions/lines

### 2.8 Complete (`complete`)
- **When:** Release candidates, major milestones
- **Duration:** ~15 minutes
- **Scope:** All test types including E2E
- **Coverage:** 70% branches, 80% functions/lines

### 2.9 Smoke Test (`smoke`)
- **When:** After deployment, quick health check
- **Duration:** ~2 minutes
- **Scope:** Build verification + critical E2E
- **Coverage:** Not required

### 2.10 Pre-Merge (`pre-merge`)
- **When:** Before merging feature branches
- **Duration:** ~10 minutes
- **Scope:** Regression + Critical E2E
- **Coverage:** 60% branches, 70% functions/lines

---

## 3. Feature Module Testing

### 3.1 Critical Features (Must have 90%+ coverage)

| Module | Unit Tests | API Tests | E2E Tests |
|--------|------------|-----------|-----------|
| Authentication | Required | Required | Required |
| Recipe Management | Required | Required | Required |
| Meal Planning | Required | Required | Required |
| Shopping Lists | Required | Required | Required |

### 3.2 High Priority Features (Must have 80%+ coverage)

| Module | Unit Tests | API Tests | E2E Tests |
|--------|------------|-----------|-----------|
| Inventory Management | Required | Required | Recommended |
| Family Profiles | Required | Required | Recommended |
| AI Nutritionist | Required | Required | Recommended |
| Nutrition Calculations | Required | Required | Optional |

### 3.3 Medium Priority Features (Must have 70%+ coverage)

| Module | Unit Tests | API Tests | E2E Tests |
|--------|------------|-----------|-----------|
| Staples Management | Required | Recommended | Optional |
| Recipe Discovery | Required | Recommended | Optional |
| Unit Conversion | Required | Optional | Optional |
| Ingredient Processing | Required | Optional | Optional |
| PDF Export | Recommended | Recommended | Optional |
| Dashboard | Recommended | Recommended | Optional |

---

## 4. MCP Tool Usage

### 4.1 Playwright MCP (E2E Testing)

**Use for:**
- Complete user journey verification
- Form submission testing
- Navigation flow testing
- Screenshot capture for visual verification
- Accessibility testing

**Capabilities:**
- `browser_navigate` - Navigate to URLs
- `browser_click` - Click elements
- `browser_type` - Type into inputs
- `browser_fill_form` - Fill multiple fields
- `browser_snapshot` - Capture accessibility tree
- `browser_take_screenshot` - Visual capture
- `browser_console_messages` - Check for errors
- `browser_network_requests` - Verify API calls

**Example E2E Test Pattern:**
```typescript
// 1. Navigate to page
await mcp.playwright.browser_navigate({ url: 'http://localhost:3000/recipes/new' })

// 2. Take accessibility snapshot
const snapshot = await mcp.playwright.browser_snapshot()

// 3. Fill form
await mcp.playwright.browser_fill_form({ fields: [...] })

// 4. Submit
await mcp.playwright.browser_click({ element: 'Submit button', ref: 'button[type=submit]' })

// 5. Verify result
const afterSnapshot = await mcp.playwright.browser_snapshot()

// 6. Check for console errors
const messages = await mcp.playwright.browser_console_messages({ level: 'error' })
```

### 4.2 Supabase MCP (Data Verification)

**Use for:**
- Database state verification after operations
- Test data seeding
- Schema validation
- Data integrity checks

**Capabilities:**
- `execute_sql` - Run queries
- `list_tables` - Inspect schema
- `apply_migration` - Schema changes
- `get_logs` - Check for database errors

**Example Verification Pattern:**
```typescript
// Verify recipe was saved
const result = await mcp.supabase.execute_sql({
  query: `SELECT * FROM "Recipe" WHERE "recipeName" = 'Test Recipe'`
})

// Verify count
const count = await mcp.supabase.execute_sql({
  query: `SELECT COUNT(*) FROM "ShoppingListItem" WHERE "shoppingListId" = '${listId}'`
})
```

### 4.3 Next.js DevTools MCP (Build Verification)

**Use for:**
- Build error detection before tests
- Runtime error monitoring during E2E
- TypeScript compilation verification

**Capabilities:**
- `nextjs_index` - List available tools
- `nextjs_call` - Call specific tools
- Error detection, route listing

---

## 5. Test Data Management

### 5.1 Test Fixtures

Location: `tests/fixtures/test-data.ts`

**Fixture Categories:**
- User fixtures (test accounts)
- Recipe fixtures (various recipe types)
- Meal plan fixtures (valid and invalid)
- Inventory fixtures (different states)
- Profile fixtures (dietary variations)

### 5.2 Database Seeding

**For API Tests:** Use mocked Prisma client (`tests/mocks/prisma.ts`)
**For E2E Tests:** Use Supabase MCP to seed test data

**Cleanup Strategy:** Each E2E test should:
1. Create its own test data
2. Use unique identifiers (timestamps/UUIDs)
3. Clean up after completion

### 5.3 Date Mocking

Always mock dates in time-sensitive tests:
```typescript
import { mockDate, restoreDate } from '../setup'

beforeEach(() => mockDate('2024-01-10'))
afterEach(() => restoreDate())
```

---

## 6. Test Execution Guidelines

### 6.1 Before Running Tests

1. Ensure dev server is NOT running on test ports
2. Clear caches if experiencing stale results:
   ```powershell
   npx jest --clearCache
   ```
3. Verify TypeScript compiles: `npx tsc --noEmit`

### 6.2 Running Tests

```powershell
# All tests
npm test

# Specific mode
npm run test:unit
npm run test:api
npm run test:integration
npm run test:e2e

# With coverage
npm run test:coverage

# Specific file
npm test -- meal-plan-validation

# Pattern matching
npm test -- --testNamePattern="cooldown"
```

### 6.3 Debugging Failed Tests

1. Run in verbose mode: `npm test -- --verbose`
2. Check console output in test logs
3. For E2E: Check screenshots in test output
4. For API: Verify mock setup

---

## 7. Continuous Integration

### 7.1 Pre-Commit

- Run `quick` mode
- TypeScript check

### 7.2 Pull Request

- Run `pre-merge` mode
- Coverage report
- Block if coverage drops

### 7.3 Main Branch

- Run `complete` mode
- Full coverage report
- Deploy to staging

### 7.4 Release

- Run `complete` mode
- Performance benchmarks
- Visual regression check

---

## 8. Test Reporting

### 8.1 Report Location

All test execution reports are stored in:
`docs/testing/execution-history/`

### 8.2 Report Naming

Format: `YYYY-MM-DD_HH-MM_<mode>.json`

Example: `2024-01-15_14-30_regression.json`

### 8.3 Report Contents

- Execution timestamp
- Mode used
- Test counts (passed/failed/skipped)
- Coverage metrics
- Duration
- Failures with stack traces
- MCP tool usage

### 8.4 History Retention

Reports are retained for **30 days** then automatically cleaned up.

---

## 9. Test Ownership

| Area | Owner | Backup |
|------|-------|--------|
| Unit Tests | Developer who wrote feature | Any team member |
| API Tests | Backend developer | Test Plan Agent |
| E2E Tests | QA / Test Plan Agent | Frontend developer |
| Test Infrastructure | Test Plan Agent | Senior developer |

---

## 10. Appendix

### A. Quick Reference Commands

```powershell
# Run all tests
npm test

# Run with coverage
npm run test:coverage

# Run specific test type
npm run test:unit
npm run test:api
npm run test:integration

# Run specific file
npm test -- meal-plan-validation

# Clear cache
npx jest --clearCache

# TypeScript check
npx tsc --noEmit
```

### B. Related Documentation

- [Project Configuration](../config/project-config.ts)
- [Test Registry](../registry/)
- [Execution History](../execution-history/)
- [CLAUDE.md](/CLAUDE.md)
